/*!
 * BnL Charts
 * 
 * D3 charting componentized using Angular directives.
 * 
 * Usage
 * -----
 * HTML:
 * 
 *   <bnl-chart chart-data="chartData" width="1200" height="300">
 *     <bnl-time-scale name="xScale" is-utc="true"></bnl-time-scale>
 *     <bnl-linear-scale name="yScale"></bnl-linear-scale>
 *     <bnl-docked-layout>                
 *       <bnl-y-axis scale="yScale" dock="left" width="25" margin="0,0,25,0"></bnl-y-axis>
 *       <bnl-x-axis scale="xScale" ticks="day" tick-format="%b %d" dock="bottom" height="25"></bnl-x-axis>                               
 *       <bnl-area scale-x="xScale" scale-y="yScale" ></bnl-area>
 *     </bnl-docked-layout>
 *   </bnl-chart>
 * 
 *   The bnl-chart data is bound via the chart-data attribute.
 *   The bnl-chart renders as an SVG element, so you can set properties on the SVG like width and height.
 * 
 *   The scales define the domain/range mapping. 
 *   They do not render anything, but are reference by name to be used by rendering components.
 * 
 *   Choose a layout container for the parts of your chart.  Based on your choice, you can apply different attributes to control layout. 
 *   Ordering parts can be important to layout and z-order of rendering.
 *   
 * Components
 * ----------
 * Modules: 
 *   bnlCharts
 * 
 * Directives:
 *   bnl-chart: Main container for a chart.
 * 
 *   bnl-x-axis: Renders an x axis
 *   bnl-y-axis: Renders a Y axis.
 * 
 *   bnl-area: Renders an area chart for a single series)
 * 
 *   bnl-absolute-layout: Positions children based on their attributes of x, y, width, height.
 *   bnl-docked-layout: Positions children based on the side they are docked (left, top, right, bottom, none).
 * 
 * 
 * Design Considerations
 * ---------------------
 * Scope: 
 *   The chart directive is isolated scope to prevent collision with other charts on the page.
 *   Each child that renders has isolated scope to allow for setting individual scope properties like width and height.
 *    
 * Transclusion:
 *   Containers (chart and layouts) transclude content to avoid requiring chart authors to edit templates.
 *   Transclusion is done manually in the directives to avoid creating an additonal isolated scope. ng-transclude is not in the templates.
 *   Layouts with isolated scopes use the chart's scope for their transcluded content to be invisible to their children.
 *   The call to $transclude is done at the tail of the method because it causes link functions to execute.  
 *   $transclude is called so that controller calls tunnel down the scope hierarchy and link calls bubble up the scope hierarchy.
 * 
 * SVG:
 *   This library avoids nesting SVG elements for grouping and uses the <g> element instead.
 *   A single SVG at the root allows the chart to scale properly; It is vector graphics after all.
 *   D3 renders based on variables in memory and not SVG containers (e.g. axis.range), so width/height containment isn't important.
 *   Browsers handle nested SVG width/height updates for rendering, but the clientWidth, clientHeight, and getBBox() are zeros for a nested SVG in JavaScript.
 */
var bnlCharts=angular.module("bnlCharts",[]);bnlCharts.directive("bnlAbsoluteLayout",[function(){return{controller:function(a,b,c,d){console.log("bnlAbsoluteLayout controller:"+a.$id),d(a.$parent,function(a,c){b.append(a)}),a.$on("bnl-chart-render",function(c,d){console.log("bnlAbsoluteLayout render:"+a.$id);var e=b[0];$.each($(b).children(),function(a,b){var c=$(b),d=c.attr("x")?Number(c.attr("x")):0,f=c.attr("y")?Number(c.attr("y")):0;d3.select(b).attr({transform:"translate("+d+","+f+")"});var g=c.attr("width")?Number(c.attr("width")):e.clientWidth,h=c.attr("height")?Number(c.attr("height")):e.clientHeight,i=angular.element(b).isolateScope();i.width=g,i.height=h})})},replace:!0,restrict:"E",scope:{},templateNamespace:"svg",template:'<g class="bnl-absolute-layout"></g>',transclude:!0}}]),bnlCharts.directive("bnlArea",[function(){var a=function(a,b,c,d,e,f){var g=d3.svg.area().x(function(a){return b(new Date(a.x))}).y0(e).y1(function(a){return e-c(a.y)}).interpolate("linear"),h=d3.select(a).selectAll(".area").data(f);h.enter().append("path").classed("area-path",!0).attr({d:g(f),width:d,height:e})};return{link:function(b,c,d,e){console.log("bnlArea link:"+b.$id),b.$on("bnl-chart-render",function(d,f){console.log("bnlArea render:"+b.$id);var g=c[0],h=(g.ownerSVGElement,e.getScale(b.scaleX).copy());h.range([0,b.width]);var i=e.getScale(b.scaleY).copy();i.range([b.height,0]);var j=e.getData();a(g,h,i,b.width,b.height,j)})},replace:!0,restrict:"E",require:"^bnlChart",scope:{chart:"=",scaleX:"@",scaleY:"@"},templateNamespace:"svg",template:'<g class="area" viewBox="0 0 250 1000"></g>'}}]),bnlCharts.directive("bnlChart",["$timeout",function(a){return{controller:function(a,b,c,d){console.log("bnlChart controller:"+a.$id);var e=(b[0],[]);this.getData=function(){return a.chartData},this.getScale=function(a){return e[a]},this.setScale=function(a,b){e[a]=b},d(a,function(a,c){b.append(a)})},link:function(b,c,d){console.log("bnlChart link:"+b.$id),a(function(){b.$broadcast("bnl-chart-prepare-data"),a(function(){b.$broadcast("bnl-chart-render")},500)},500)},replace:!0,restrict:"E",scope:{chartData:"="},templateNamespace:"svg",template:"<svg></svg>",transclude:!0}}]),bnlCharts.directive("bnlDockedLayout",[function(){var a=function(a){var b={top:0,right:0,bottom:0,left:0};if(a){var c=a.split(",");switch(c.length){case 1:var d=Number(c[0]);isNaN(d)||(b.top=d,b.right=d,b.bottom=d,b.left=d);break;case 2:var e=Number(c[0]),f=Number(c[1]);isNaN(e)||(b.top=e,b.bottom=e),isNaN(f)||(b.right=f,b.left=f);break;case 3:var g=Number(c[0]),f=Number(c[1]),h=Number(c[2]);isNaN(g)||(b.top=g),isNaN(f)||(b.right=f,b.left=f),isNaN(h)||(b.bottom=h);break;default:if(c.length>=4){var g=Number(c[0]),i=Number(c[1]),h=Number(c[2]),j=Number(c[3]);isNaN(g)||(b.top=g),isNaN(i)||(b.right=i),isNaN(h)||(b.bottom=h),isNaN(j)||(b.left=j)}}}return b},b=function(a,b,c,d,e){(0!==b||0!==c)&&d3.select(a).attr({transform:"translate("+b+","+c+")"});var f=angular.element(a).isolateScope();f.width=d,f.height=e};return{controller:function(c,d,e,f){console.log("bnlDockedLayout controller:"+c.$id),f(c.$parent,function(a,b){d.append(a)}),c.$on("bnl-chart-render",function(e,f){console.log("bnlDockedLayout render:"+c.$id);var g=d[0],h=g.ownerSVGElement,i=0,j=0,k=c.width?c.width:h.clientWidth,l=c.height?c.height:h.clientHeight,m=[],n={top:0,right:k,bottom:l,left:0};$.each($(d).children(),function(c,d){var e=$(d),f=a(e.attr("margin")),g=i+f.left,h=j+f.top,o=e.attr("width")?Number(e.attr("width")):k,p=e.attr("height")?Number(e.attr("height")):l,q=f.top+p+f.bottom,r=f.left+o+f.right,s=e.attr("dock");if(s)switch(s){case"top":n.top=Math.max(j+q,n.top),o-=f.left+f.right;break;case"right":n.right=Math.min(k-r,n.right),g=k-r,p-=f.top+f.bottom;break;case"bottom":n.bottom=Math.min(l-q,n.bottom),h=l-q,o-=f.left+f.right;break;case"left":n.left=Math.max(i+r,n.left),p-=f.top+f.bottom;break;default:console.log('The dock attribute "'+s+'" is not supported by bnl-docked-layout. The element will be treated as undocked.'),s=void 0}s?b(d,g,h,o,p):m.push({child:d,childMargin:f})});for(var o=0;o<m.length;o++){var p=m[o].child,q=m[o].childMargin,r=n.left+q.left,s=n.top+q.top,t=n.right-q.right-r,u=n.bottom-q.bottom-s;b(p,r,s,t,u)}})},replace:!0,restrict:"E",scope:{},templateNamespace:"svg",template:'<g class="bnl-docked-layout"></g>',transclude:!0}}]),angular.module("bnlCharts").directive("bnlLinearScale",[function(){var a=function(a){var b=d3.scale.linear(),c=0,d=0;return a&&(c=d3.min(a,function(a){return a.y}),d=d3.max(a,function(a){return a.y})),c=Math.min(0,c),d=Math.max(1,d),b.domain([c,d]),b};return{link:function(b,c,d,e){console.log("bnlLinearScale link:"+b.$id),b.$on("bnl-chart-prepare-data",function(c,d){console.log("bnlLinearScale prepare:"+b.$id);var f=b.name;if(f){var g=e.getData(),h=a(g);e.setScale(f,h)}})},restrict:"E",require:"^bnlChart",scope:{chart:"=",name:"@"}}}]),angular.module("bnlCharts").directive("bnlTimeScale",function(){var a=function(a,b){var c;c=b?d3.time.scale.utc():d3.time.scale();var d=a&&a.length>0?new Date(a[0].x):new Date,e=a&&a.length>0?new Date(a[a.length-1].x):d;return c.domain([d,e]),c};return{link:function(b,c,d,e){console.log("bnlTimeScale link:"+b.$id),b.$on("bnl-chart-prepare-data",function(c,d){console.log("bnlTimeScale prepare:"+b.$id);var f=b.name;if(f){var g=e.getData(),h=a(g,b.isUtc);e.setScale(f,h)}})},restrict:"E",require:"^bnlChart",scope:{name:"@",isUtc:"=?"}}}),bnlCharts.directive("bnlXAxis",[function(){var a=function(a,b,c,d){if(xAxis=d3.svg.axis().scale(b).orient("bottom"),c){var e=Number(c);if(isNaN(e)){var f=c.split(",");if(f.length>0){var g=1;switch(2==f.length&&(g=Number(f[1]),g=isNaN(g)?void 0:g),f[0]){case"second":xAxis.ticks(d3.time.second,g);break;case"minute":xAxis.ticks(d3.time.minute,g);break;case"hour":xAxis.ticks(d3.time.hour,g);break;case"day":xAxis.ticks(d3.time.day,g);break;case"week":xAxis.ticks(d3.time.week,g);break;case"month":xAxis.ticks(d3.time.month,g);break;case"year":xAxis.ticks(d3.time.year,g)}}}else xAxis.ticks(e)}d&&xAxis.tickFormat(d3.time.format(d)),d3.select(a).call(xAxis)};return{link:function(b,c,d,e){console.log("bnlXAxis link:"+b.$id),b.$on("bnl-chart-render",function(d,f){console.log("bnlXAxis render:"+b.$id);var g=c[0],h=(g.ownerSVGElement,e.getScale(b.scale).copy());h.range([0,b.width]),a(g,h,b.ticks,b.tickFormat)})},replace:!0,restrict:"E",require:"^bnlChart",scope:{scale:"@",ticks:"@",tickFormat:"@"},templateNamespace:"svg",template:'<g class="axis x-axis"></g>'}}]),bnlCharts.directive("bnlYAxis",[function(){var a=function(a,b,c,d){yAxis=d3.svg.axis().scale(b).orient("left"),x=c,d3.select(a).select(".y-axis").attr({transform:"translate("+x+",0)"}).call(yAxis)};return{link:function(b,c,d,e){console.log("bnlYAxis link:"+b.$id),b.$on("bnl-chart-render",function(d,f){console.log("bnlYAxis render:"+b.$id);var g=c[0],h=(g.ownerSVGElement,e.getScale(b.scale).copy());h.range([b.height,0]),a(g,h,b.width,b.height)})},replace:!0,restrict:"E",require:"^bnlChart",scope:{chart:"=",scale:"@"},templateNamespace:"svg",template:'<g><g class="axis y-axis"></g></g>'}}]);